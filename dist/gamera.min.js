/*! gamera 22-11-2014 */
!function(){function a(a){for(var b in l){var c=!0;b.split(".").forEach(function(b){a.components[b]||(c=!1)}),c&&(l[b][a.id]=a)}}function b(a){var b,c=[];for(b in a)c.push(a[b]);return c}function c(){return(524288*(1+Math.random())|0).toString(16)}function d(a){for(var b=1;b<arguments.length;b++){var c="function"==typeof arguments[b]?arguments[b]():arguments[b];for(var d in c)hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a}function e(a){this.entities=f,this.components=g,this.systems=h,this.attributes=j=a,this.C=l,i.forEach(function(a){a.call(this,this)}.bind(this))}var f={},g={},h=[],i=[],j={},k=!1,l={};e.prototype={get:function(a){return j[a]},set:function(a,b){j[a]=b,this.trigger("change:"+a,b)},entity:function(a,b){return"object"==typeof a&&(b=a,a=c()),f[a]=new e.Entity(a,b),this.trigger("entity:added",f[a]),f[a]},removeEntity:function(a){delete f[a];for(var b in l)l[b][a]&&delete l[b][a];this.trigger("entity:removed",a)},component:function(a,b){"object"==typeof a&&(b=a,a=b.id||c()),g[a]=e.Component.extend({id:a,game:this},b),this.trigger("component:added",g[a])},system:function(a,b){"object"==typeof a&&(b=a,a=b.id||c());var d=new(e.System.extend({id:a,game:this},b));h.push(d),this.trigger("system:added",d)},removeSystem:function(a){var b;h.forEach(function(c,d){c.id==a&&(b=d)}),b&&h.splice(b,1),this.trigger("system:removed",a)},getEntity:function(a){return f[a]},getEntities:function(){var c=Array.prototype.slice.call(arguments,0).sort().join(".");if(l[c])return b(l[c]);l[c]={};for(var d in f)a(f[d]);return b(l[c])},start:function(a){k||(h.sort(function(a,b){return a.order||0>b.order||0}),k=!0,this.trigger("start",this),function b(){h.forEach(function(a){!window.paused&&a.update&&a.update.call(a),a.draw&&a.draw.call(a)}),k&&window.requestAnimationFrame(b,a)}())},stop:function(){k=!1,this.trigger("stop",this)}},e.Object={extend:function(){var a=function(){return this.init&&this.init.apply(this,arguments)};return d(a.prototype,this.prototype,d.apply(this,arguments)),d(a,e.Object),a}},e.Entity=e.Object.extend({init:function(a,b){this.components={},this.id=a;for(var c in b)this.add(c,b[c])},get:function(a){return this.components[a]},remove:function(a){delete this.components[a];for(var b in l)b.match(a)&&l[b]&&delete l[b][this.id]},add:function(b,c){this.components[b]=function(a,b,c){return b.constructor==Array||(b=[b]),g[a]?(c=function(){return g[a].apply(this,b)},c.prototype=g[a].prototype,new c):void 0}.bind(this)(b,c),a(this)}}),e.System=e.Object.extend({getEntity:function(){return this.game.getEntity.apply(this,arguments)},getEntities:function(){return this.game.getEntities.apply(this,arguments)}}),e.Component=e.Object.extend({init:function(a){for(var b in a||{})this[b]=a[b]}}),e.extend=d,e.plugin=function(a){i.push(a)},e.Events=function(){var a={};return{ge:function(){return a},on:function(b,c){a[b]=a[b]||[],a[b].push(c)},off:function(b,c){a[b]&&(c?a[b].splice(a[b].indexOf(c),1):a[b]=[])},trigger:function(b){var c=Array.prototype.slice.call(arguments,1);a[b]&&a[b].forEach(function(a){a.apply(this,c)}.bind(this))}}},d(e.prototype,e.Events.call(e.prototype)),d(e.System.prototype,e.Events.call(e.System.prototype)),window.Gamera=e}();