/*! gamera 14-09-2015 */
!function(){function a(a){var b,c=[];for(b in a)c.push(a[b]);return c}function b(){return(524288*(1+Math.random())|0).toString(16)}function c(a){for(var b,c,d,e=1;e<arguments.length;e++){b=arguments[e],d="function"==typeof b?b():b;for(c in d)hasOwnProperty.call(d,c)&&(a[c]=d[c])}return a}var d=[],e=c(function(){},{mixin:function(a){var b=this.prototype.init,d=a.init;d&&(this.prototype.init=function(){b.apply(this,arguments),d.apply(this,arguments)},delete a.init),c(this.prototype,a)},extend:function(){var a="prototype",b=function(){return this.init&&this.init.apply(this,arguments)},d=function(){this.constructor=b};d[a]=this[a],b[a]=new d,c(b[a],c.apply(this,arguments));for(k in e)b[k]=e[k];return b}}),f=e.extend({init:function(a){this.entities={},this.components={},this.systems=[],this.running=!1,this._attrs=a||{},d.forEach(function(a){a.call(this,this)}.bind(this))},get:function(a){return this._attrs[a]},set:function(a,b){this._attrs[a]=b,this.trigger("change:"+a,b)},entity:function(a,c){var d=this.entities;return"object"==typeof a&&(c=a,a=b()),d[a]=new f.Entity(this,a,c),this.trigger("entity:added",d[a]),d[a]},removeEntity:function(a){f.Cache.remove(a),delete this.entities[a],this.trigger("entity:removed",a)},component:function(a,b){var c=this.components[a]=f.Component.extend({id:a,game:this},b);this.trigger("component:added",c)},system:function(a,c){"object"==typeof a&&(c=a,a=c.id||b());var d=new(f.System.extend({id:a,game:this},c));this.systems.push(d),this.trigger("system:added",d)},removeSystem:function(a){var b,c=this.systems;c.forEach(function(c,d){c.id==a&&(b=d)}),b&&c.splice(b,1),this.trigger("system:removed",a)},getEntity:function(a){return this.entities[a]},getEntities:function(){var b=Array.prototype.slice.call(arguments,0).sort().join("."),c=f.Cache._cache;if(c[b])return a(c[b]);c[b]={};for(var d in this.entities)f.Cache.update(this.entities[d]);return a(c[b])},start:function(a){var b=this;this.running||(this.systems.sort(function(a,b){return a.order||0>b.order||0}),this.running=!0,this.trigger("start",this),function c(){b.systems.forEach(function(a){a.update&&a.update.call&&a.update.call(a)}),b.running&&window.requestAnimationFrame(c,a)}())},stop:function(){this.running=!1,this.trigger("stop",this)}});f.Object=e,f.Entity=f.Object.extend({init:function(a,b,c){this.components={},this.id=b,this.game=a;for(var d in c)this.add(d,c[d])},get:function(a){var b,c=a.split("."),d=this.components;for(b=0;b<c.length;b++)d=d[c[b]];return d},remove:function(a){f.Cache.update(this),delete this.components[a]},add:function(a,b){var c=this.game.components;this.components[a]=function(a,b,d){return b.constructor==Array||(b=[b]),c[a]?(d=function(){return c[a].apply(this,b)},d.prototype=c[a].prototype,new d):void 0}.bind(this)(a,b),f.Cache.update(this)}}),f.System=f.Object.extend({getEntity:function(){return this.game.getEntity.apply(this.game,arguments)},getEntities:function(){return this.game.getEntities.apply(this.game,arguments)}}),f.Component=f.Object.extend({init:function(a){for(var b in a||{})this[b]=a[b]}}),f.plugin=function(a){d.push(a)},f.Cache={_cache:{},update:function(a){this.remove(a.id);for(var b in this._cache){var c=!0;b.split(".").forEach(function(b){a.components[b]||(c=!1)}),c&&(this._cache[b][a.id]=a)}},remove:function(a){for(var b in this._cache)this._cache[b][a]&&delete this._cache[b][a]}},f.Events={on:function(a,b){this.events||(this.events={}),this.events[a]=this.events[a]||[],this.events[a].push(b)},off:function(a,b){this.events&&this.events[a]&&(b?this.events[a].splice(this.events[a].indexOf(b),1):this.events[a]=[])},trigger:function(a){var b=Array.prototype.slice.call(arguments,1);this.events&&this.events[a]&&this.events[a].forEach(function(a){a.apply(this,b)}.bind(this))}},f.mixin(f.Events),f.Entity.mixin(f.Events),f.System.mixin(f.Events);var g=this;"function"==typeof define&&define.amd?define("Gamera",[],function(){return f}):"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=f),exports.Gamera=f):g.Gamera=f}();